---
layout: post
title: Cropper 图片裁剪上传
category : [学习问题记录]
tagline: "Supporting tagline"
tags : [Cropper]
---

# Cropper 图片裁剪上传 

页面(需要在页面中引入 cropper.css 和 copper.js):    

``` 
<div class="row">
  <div class="col-md-6">
    <label title="Upload image file" for="inputImage" class="btn btn-primary">
    <input type="file" accept="content/images/*" name="file" id="inputImage"
                                                 class="hide">选择图片
    </label>
    <button type="button" id="uploadLogo" class="btn btn-primary">上传</button>
    <div class="image-crop m-t-xs" style="max-height: 300px;">
    	<img th:if="*{#strings.isEmpty(logo) or !#strings.contains(logo,'.blob')}" src="">
        <img th:if="*{!#strings.isEmpty(logo) and #strings.contains(logo,'.blob')}" th:src="@{/croppedImages/{logo}(logo=*{logo})}" width="300" height="300">
    </div>
  </div>
</div>
```

<!--break-->

js:   
```  
// 从本地选择裁剪图片
var $inputImage = $('#inputImage');
if (window.FileReader) {
    $inputImage.change(function () {
        var fileReader = new FileReader(),
            files = this.files,
            file;

        if (!files.length) {
            return;
        }

        file = files[0];

        if (/^image\/\w+$/.test(file.type)) {
            fileReader.readAsDataURL(file);
            fileReader.onload = function () {
                $inputImage.val('');
                $image.cropper('reset', true).cropper('replace', this.result);
            };
            $('#cropperModal').modal('show');
        } else {
            showMessage('请选择图片.');
        }
    });
} else {
    $inputImage.addClass('hide');
}
       
// 初始化裁剪插件
var $image = $('.image-crop > img');  
$($image).cropper({
	viewMode: 1,
    aspectRatio: 1,
    preview: '.img-preview',
    done: function (data) {
    // Output the result data for cropping image.
    }
}); 
              
// 裁剪图片并上传
$('#uploadLogo').on('click', function () {
    var dataUrl = $('.image-crop > img');
    // var beginIndex = dataUrl.attr('src').indexOf('/') + 1;
    // var endIndex = dataUrl.attr('src').indexOf(';');
    // var ext = dataUrl.attr('src').substring(beginIndex, endIndex);
    // if (endIndex < beginIndex) {
    //     ext = dataUrl.attr('src').substring(dataUrl.attr('src').lastIndexOf(".") + 1)
    // }

    var cropper = dataUrl.cropper('getCroppedCanvas');
    // var imgUrl = dataUrl.toDataURL();
    // var img = document.createElement("inputImage");
    // img.src = imgUrl;
    // document.getElementById("logoImg").appendChild(img);

    //可以直接保存 DataURL,这里保存了base64文件的文件名
    cropper.toBlob(function (blob) {
        var formData = new FormData();
        formData.append('file', blob);
        $.ajax('/imgCut', {
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                $('#url').val(res);
                toastr.success("图片上传成功");
            },
            error: function () {
                toastr.success("图片上传失败");
            }
        });
    });
}); 
```

Java 后台代码:   
``` 
/**
* 上传裁剪的图片
*
* @param file
* @return
*/
@PostMapping("/imgCut")
public ResponseEntity imgCut(@RequestParam("file") MultipartFile file) {
	String fileName;

    try {
    	fileName = uploadFile(file, imgUploadPath);
    } catch (Exception e) {
        e.printStackTrace();
        return ResponseEntity.badRequest().build();
    }
    return ResponseEntity.ok(fileName);
}

/**
* 根据文件名在页面显示图片
*
* @param fileName
* @param response
*/
@RequestMapping("/croppedImages/{fileName:.+}")
public void blobToImage(@PathVariable("fileName") String fileName, HttpServletResponse response) {
	try {
		if (StringUtils.isEmpty(fileName)) {
			return;
        }
        response.setHeader("Content-Type", "image/png");
        response.getOutputStream().write(file2ByteArray(imgUploadPath + fileName));
    } catch (Exception e) {
        	e.printStackTrace();
    }
}
```

开始裁剪上传时把图片上传时的文件格式页传到后台了，后台根据图片格式设置输出文件的 MIME ( `response.setHeader("Content-Type", "image/" + ext);` )，但是 IE 浏览器显示非 png 格式的图片时,控制台会报错: 

``` 
IE 无法解码 URL 处图像
```

是因为设置的图片格式与图片原来的格式不一致,虽然文件上传时获取到了格式并且传递到了后台，Cropper 插件在转换时首先把图像转成 PNG 数据，然后再把得到的二进制的 PNG 数据转成纯 ASCII 的 base64 编码的字符串,所以后台拿到的base64数据是从png格式的图片获取到的。

> https://fanghe1995.github.io/2017/08/25/IE-DOM7009/ 
>
> https://www.cnblogs.com/zichi/p/5070895.html 
> 
> https://www.cnblogs.com/hustskyking/p/data-uri.html 